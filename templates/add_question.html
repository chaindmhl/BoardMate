<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Questions | BoardMate</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { font-family: "Poppins", Arial, sans-serif; background-color: #f4f6f8; color: #333; }
    /* Slim Navbar */
    .navbar {
      background-color: #1f2937;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding-top: 6px !important;
      padding-bottom: 6px !important;
    }

    .navbar-brand {
      font-weight: 600;
      color: #fff !important;
      font-size: 1.1rem;
    }

    .navbar-brand:hover {
        color: #10b981 !important; 
        transform: scale(1.05);
    }

    .nav-link {
      color: #fff !important;
      transition: color 0.3s ease;
      font-size: 1 rem;
    }

    .nav-link:hover {
      color: #10b981 !important;
    }

    h1 { text-align:center; margin:40px 0 20px; color:#1f2937; font-weight:600; }
    form { max-width: 900px; margin:0 auto 50px; }
    .question-block { border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; padding:15px; margin-bottom:20px; }
    .question-block:hover { box-shadow:0 2px 12px rgba(0,0,0,0.08); background:#fff; }
    .upload-button { display:none; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px; width:100%; font-weight:500; cursor:pointer; }
    .upload-button:hover { background:#1d4ed8; }
    .generate-btn { background:#10b981; color:#fff; border:none; width:100%; }
    .generate-btn:hover { background:#059669; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'home' %}">BoardMate</a>
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="{% url 'question_bank' %}">Question Bank</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<h1>Add Questions</h1>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="row g-3 align-items-end mb-4">
    <div class="col-md-6">
      <label for="boardExamSelect" class="form-label fw-semibold">Select Board Exam</label>
      <select id="boardExamSelect" class="form-select" required>
        <option value="">-- Choose Board Exam --</option>
        {% for exam in BOARD_EXAMS %}
          <option value="{{ exam }}">{{ exam }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label for="numQuestions" class="form-label fw-semibold">Number of Questions</label>
      <input type="number" id="numQuestions" class="form-control" min="1" max="50" placeholder="e.g. 10" />
    </div>
    <div class="col-md-2">
      <button type="button" class="btn generate-btn" onclick="generateQuestionFields()">Create</button>
    </div>
  </div>

  <div id="questionsContainer"></div>
  <button type="submit" class="upload-button mt-3">Save All Questions</button>
</form>

<script>
  const BOARD_EXAM_TOPICS = JSON.parse('{{ BOARD_EXAM_TOPICS_JSON|escapejs }}');
  const LEVELS = JSON.parse('{{ LEVELS_JSON|escapejs }}');

  function generateQuestionFields() {
    const container = document.getElementById("questionsContainer");
    const numQuestions = parseInt(document.getElementById("numQuestions").value);
    const boardExamSelect = document.getElementById("boardExamSelect");
    const selectedBoardExam = boardExamSelect.value;
    container.innerHTML = "";
    const submitBtn = document.querySelector(".upload-button");
    submitBtn.style.display = "none";

    if (!selectedBoardExam) { alert("Select a board exam first!"); return; }
    if (!numQuestions || numQuestions <= 0) { alert("Enter a valid number"); return; }

    const subjectsObj = BOARD_EXAM_TOPICS[selectedBoardExam];

    for (let i = 1; i <= numQuestions; i++) {
      const block = document.createElement("div");
      block.classList.add("question-block");

      // Subjects options
      let subjectOptions = '<option value="">--Select Subject--</option>';
      for (let sub in subjectsObj) {
        subjectOptions += `<option value="${sub}">${sub}</option>`;
      }

      // Difficulty levels
      let difficultyOptions = LEVELS.map(lvl => `<option value="${lvl}">${lvl}</option>`).join("");

      block.innerHTML = `
        <!-- Hidden input to store selected board exam -->
        <input type="hidden" name="board_exam_${i}" value="${selectedBoardExam}">

        <h5>Question ${i}</h5>

        <div class="mb-3">
          <label>Attach Image (optional)</label>
          <input type="file" name="image_${i}" class="form-control" accept="image/*">
        </div>

        <textarea name="question_text_${i}" class="form-control mb-3" rows="2" placeholder="Enter question text..." required></textarea>

        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" name="is_general_${i}" id="is_general_${i}">
          <label class="form-check-label" for="is_general_${i}">
            Mark as General Engineering (available to all courses)
          </label>
        </div>

        <div class="mb-3">
          <label>Subject</label>
          <select name="subject_${i}" class="form-select" required>${subjectOptions}</select>
        </div>
        <div class="mb-3">
          <label>Topic</label>
          <select name="topic_${i}" class="form-select" required>
            <option value="">--Select Topic--</option>
          </select>
        </div>
        <div class="mb-3">
          <label>Difficulty</label>
          <select name="level_${i}" class="form-select" required>${difficultyOptions}</select>
        </div>

        <div class="mb-3">
          <label>Choices</label>
          <div class="row g-2 align-items-center mb-1">
            <div class="col-auto fw-bold">A.</div>
            <div class="col"><input type="text" name="choiceA_${i}" class="form-control" placeholder="Choice A" required></div>
          </div>
          <div class="row g-2 align-items-center mb-1">
            <div class="col-auto fw-bold">B.</div>
            <div class="col"><input type="text" name="choiceB_${i}" class="form-control" placeholder="Choice B" required></div>
          </div>
          <div class="row g-2 align-items-center mb-1">
            <div class="col-auto fw-bold">C.</div>
            <div class="col"><input type="text" name="choiceC_${i}" class="form-control" placeholder="Choice C" required></div>
          </div>
          <div class="row g-2 align-items-center mb-1">
            <div class="col-auto fw-bold">D.</div>
            <div class="col"><input type="text" name="choiceD_${i}" class="form-control" placeholder="Choice D" required></div>
          </div>
          <div class="row g-2 align-items-center">
            <div class="col-auto fw-bold">E.</div>
            <div class="col"><input type="text" name="choiceE_${i}" class="form-control" placeholder="Choice E (optional)"></div>
          </div>
        </div>

        <div class="mb-3">
          <label>Correct Answer</label>
          <select name="correct_answer_${i}" class="form-select" required>
            <option value="" disabled selected>Select correct answer</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
          </select>
        </div>
      `;

      container.appendChild(block);

      // Populate topics dynamically
      const subjectSelect = block.querySelector(`select[name="subject_${i}"]`);
      const topicSelect = block.querySelector(`select[name="topic_${i}"]`);
      subjectSelect.addEventListener("change", () => {
        topicSelect.innerHTML = '<option value="">--Select Topic--</option>';
        const selectedSubject = subjectSelect.value;
        if (subjectsObj[selectedSubject]) {
          subjectsObj[selectedSubject].forEach(t => {
            topicSelect.add(new Option(t, t));
          });
        }
      });
    }

    submitBtn.style.display = "block";
    container.scrollIntoView({ behavior: "smooth" });
  }
</script>

</body>
</html>
